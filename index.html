<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#222222">
    <link rel="manifest" href="manifest.json">
    <title>GRNDbrekers Rodeo Bull - StuDAY 2025</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .screen {
            display: none;
            flex: 1;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .screen.active {
            display: flex;
        }

        .screen-content {
            max-width: 400px;
            width: 100%;
        }

        .logo-container {
            margin-bottom: 30px;
        }

        .logo {
            width: 300px;
            height: 180px;
            margin: 0 auto 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            min-height: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: inline-block;
            width: auto;
        }

        /* Specific button styles */
        .btn-blue {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-green {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-red {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .top-button {
            background: linear-gradient(45deg, #FFD700, #FFA000);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: block;
            margin: 0 auto 20px;
        }

        /* Button hover effects */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-blue:hover, .btn-green:hover, .btn-red:hover, .top-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .input-field, select.input-field {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .input-field::placeholder {
            color: rgba(255,255,255,0.7);
        }

        select.input-field {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        select.input-field option {
            background: #333;
            color: white;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        .rider-tag {
            display: flex;
            align-items: center;
            background: rgba(76,175,80,0.3);
            color: white;
            padding: 10px 15px;
            margin: 8px;
            border-radius: 20px;
            border: 1px solid #4CAF50;
            font-size: 14px;
            position: relative;
        }

        .rider-photo-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }

        .rider-photo-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rider-info {
            flex: 1;
            text-align: left;
        }

        .rider-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .remove-btn {
            background: rgba(255,107,53,0.8);
        }

        /* Time input layout */
        .time-inputs-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
            max-width: 100%;
        }

        .time-input {
            width: 70px;
            padding: 12px 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .time-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .time-separator {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin: 0 2px;
        }

        /* Side buttons layout for name entry screen */
        .side-buttons-name {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            width: 100%;
        }

        /* Side buttons layout for time entry screen */
        .side-buttons-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            width: 100%;
        }

        /* Leaderboard navigation buttons */
        .leaderboard-nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .leaderboard-logo {
            width: 100%;
            max-width: none;
            max-height: 300px;
            object-fit: contain;
            margin: 0 auto 25px;
            display: block;
            border-radius: 15px;
        }

        .remaining-riders {
            margin-top: 30px;
        }

        .remaining-riders h3 {
            text-align: center;
            margin-bottom: 15px;
            opacity: 0.8;
            font-size: 16px;
        }

        .remaining-leaderboard {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 10px;
        }

        .remaining-entry {
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
            padding: 12px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: 60px 50px 1fr 80px;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .remaining-position {
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }

        .remaining-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .remaining-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remaining-name {
            font-weight: bold;
            font-size: 14px;
        }

        .remaining-time {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        h1, h2 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .added-names {
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .debug {
            display: none; /* Hidden in production */
        }

        .photo-input-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            padding: 10px 20px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 20px;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .photo-option {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .photo-option:hover {
            background: rgba(255,255,255,0.2);
            border-color: #4CAF50;
        }

        .photo-option.selected {
            border-color: #FFD700;
            background: rgba(255,215,0,0.2);
        }

        .photo-option img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .photo-option-text {
            font-size: 12px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            .leaderboard-logo {
                max-width: 100%;
                max-height: 300px;
            }
            
            .time-input {
                width: 55px;
                padding: 10px 6px;
                font-size: 14px;
            }
            
            .time-separator {
                font-size: 18px;
                margin: 0 1px;
            }
            
            .screen-content {
                padding: 10px;
            }
            
            .top-button, .btn-red {
                padding: 10px 20px;
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .btn-blue, .btn-green {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .side-buttons-name, .side-buttons-time {
                margin: 15px 0;
            }

            .leaderboard-nav-buttons {
                margin-bottom: 10px;
            }
            
            .remaining-entry {
                grid-template-columns: 50px 40px 1fr 70px;
                gap: 8px;
                padding: 10px;
            }

            .rider-tag {
                padding: 8px 12px;
            }

            .rider-photo-small {
                width: 35px;
                height: 35px;
            }

            .rider-actions {
                gap: 3px;
            }

            .action-btn {
                padding: 4px 6px;
                font-size: 11px;
            }

            .photo-gallery {
                grid-template-columns: repeat(3, 1fr);
            }

            .photo-preview {
                width: 80px;
                height: 80px;
            }

            .photo-input-section {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="debug" id="debug">Loading...</div>

    <!-- Home Screen -->
    <div class="screen active" id="homeScreen">
        <div class="screen-content">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://raw.githubusercontent.com/SergeHanssens/grndbrekers-bull-studay2025/images/grndbrekers-bull-logo-transparant-V5.png" 
                         alt="GRNDbrekers Logo"
                         onerror="this.outerHTML='<div style=color:white;font-size:18px;>🛠️ GRNDbrekers 🐂<br><small>Bull Riding Leaderboard</small></div>';">
                </div>
            </div>
            <button class="btn" onclick="showScreen('nameEntryScreen')">Start Leaderboard!</button>
        </div>
    </div>

    <!-- Name Entry Screen -->
    <div class="screen" id="nameEntryScreen">
        <div class="screen-content">
            <button class="top-button" onclick="showScreen('leaderboardScreen')">🏆 Ranking</button>
            
            <h2>Voeg Rijders Toe</h2>
            
            <!-- Photo Section -->
            <div class="photo-input-section">
                <div class="photo-preview" id="photoPreview">
                    📷
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
                <button class="btn photo-btn" onclick="document.getElementById('photoInput').click()">Foto Maken (Optioneel)</button>
            </div>
            
            <input type="text" class="input-field" id="riderName" placeholder="Naam van rijder" style="margin-top: 0;">
            
            <div class="side-buttons-name">
                <button class="btn-blue" onclick="addRider()">Opslaan</button>
                <button class="btn-green" onclick="showScreen('timeEntryScreen')" id="nextToTimeBtn" style="display: none;">Tijden</button>
            </div>
            
            <div class="added-names" id="addedNames"></div>
        </div>
    </div>

    <!-- Time Entry Screen -->
    <div class="screen" id="timeEntryScreen">
        <div class="screen-content">
            <button class="top-button" onclick="showScreen('leaderboardScreen')">🏆 Ranking</button>
            
            <h2>Voeg Tijd Toe</h2>
            <select class="input-field" id="riderSelect">
                <option value="">Selecteer rijder...</option>
            </select>
            
            <div class="time-inputs-container">
                <input type="number" class="time-input" id="minutes" placeholder="Min" min="0" max="999">
                <span class="time-separator">:</span>
                <input type="number" class="time-input" id="seconds" placeholder="Sec" min="0" max="59">
                <span class="time-separator">:</span>
                <input type="number" class="time-input" id="hundredths" placeholder="1/100" min="0" max="99">
            </div>
            
            <div class="side-buttons-time">
                <button class="btn-blue" onclick="addTime()">Opslaan</button>
                <button class="btn-green" onclick="showScreen('nameEntryScreen')">Rijders</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div class="screen" id="leaderboardScreen">
        <div class="screen-content">
            <button class="btn-red" onclick="resetAll()">🗑️ Reset</button>
            
            <!-- Logo Header -->
            <div class="leaderboard-header">
                <img src="https://raw.githubusercontent.com/SergeHanssens/grndbrekers-bull-studay2025/images/grndbrekers-bull-logo-transparant-V5.png" 
                     alt="GRNDbrekers Logo" class="leaderboard-logo"
                     onerror="this.outerHTML='<h2 style=color:white;>🛠️ GRNDbrekers Bull Riding</h2>';">
            </div>
            
            <!-- Navigation buttons above list -->
            <div class="leaderboard-nav-buttons">
                <button class="btn-green" onclick="showScreen('timeEntryScreen')">Tijd</button>
                <button class="btn-green" onclick="showScreen('nameEntryScreen')">Rijders</button>
            </div>
            
            <!-- Leaderboard List -->
            <div class="remaining-riders" id="leaderboardSection">
                <div id="leaderboardList"></div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditModal()">×</button>
            <h3>Rijder Bewerken</h3>
            
            <div class="photo-input-section">
                <div class="photo-preview" id="editPhotoPreview">
                    📷
                </div>
                <input type="file" id="editPhotoInput" accept="image/*" capture="environment" style="display: none;">
                <button class="btn photo-btn" onclick="document.getElementById('editPhotoInput').click()">Foto Wijzigen</button>
            </div>
            
            <input type="text" class="input-field" id="editRiderName" placeholder="Naam van rijder">
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveEditedRider()">Wijzigingen Opslaan</button>
                <button class="btn" onclick="closeEditModal()" style="background: rgba(255,255,255,0.2);">Annuleren</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Name Modal -->
    <div class="modal" id="duplicateModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDuplicateModal()">×</button>
            <h3>Naam bestaat al</h3>
            <p id="duplicateMessage">Deze naam is al gebruikt. Kies een foto:</p>
            
            <div class="photo-gallery" id="photoGallery"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="useSelectedPhoto()">Gebruik Geselecteerde Foto</button>
                <button class="btn photo-btn" onclick="takeNewPhoto()">Nieuwe Foto Maken</button>
                <button class="btn" onclick="addWithoutPhoto()" style="background: linear-gradient(45deg, #9C27B0, #673AB7);">Voeg Toe Zonder Foto</button>
            </div>
        </div>
    </div>

    <script>
        // Debug function
        function updateDebug(message) {
            // Debug disabled in production
            console.log('DEBUG:', message);
        }

        updateDebug('Script starting...');

        // Global variables
        window.riders = [];
        window.leaderboardData = [];
        window.currentPhoto = null;
        window.editingRiderIndex = null;
        window.duplicateName = '';
        window.selectedPhotoForDuplicate = null;

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Get all photos for a name
        function getPhotosForName(name) {
            const photos = [];
            window.riders.forEach(rider => {
                if (rider.name.toLowerCase() === name.toLowerCase() && rider.photo) {
                    photos.push({
                        photo: rider.photo,
                        id: rider.id,
                        hasTime: !!rider.time
                    });
                }
            });
            
            // Also check leaderboard for completed riders
            window.leaderboardData.forEach(entry => {
                if (entry.name.toLowerCase() === name.toLowerCase() && entry.photo) {
                    const existing = photos.find(p => p.photo === entry.photo);
                    if (!existing) {
                        photos.push({
                            photo: entry.photo,
                            id: entry.id,
                            hasTime: true
                        });
                    }
                }
            });
            
            return photos;
        }

        // Photo compression function
        function compressImage(file, maxWidth = 150, maxHeight = 150, quality = 0.7) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Handle photo selection
        document.addEventListener('DOMContentLoaded', function() {
            // Main photo input
            document.getElementById('photoInput').addEventListener('change', async function(e) {
                if (e.target.files && e.target.files[0]) {
                    const compressed = await compressImage(e.target.files[0]);
                    window.currentPhoto = compressed;
                    
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `<img src="${compressed}" alt="Preview">`;
                }
            });

            // Edit photo input
            document.getElementById('editPhotoInput').addEventListener('change', async function(e) {
                if (e.target.files && e.target.files[0]) {
                    const compressed = await compressImage(e.target.files[0]);
                    
                    const preview = document.getElementById('editPhotoPreview');
                    preview.innerHTML = `<img src="${compressed}" alt="Preview">`;
                    preview.dataset.newPhoto = compressed;
                }
            });
        });

        // Simple screen navigation
        window.showScreen = function(screenId) {
            updateDebug('Switching to: ' + screenId);
            
            // Hide all screens
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                updateDebug('Screen active: ' + screenId);
                
                // Update dropdown when going to time screen
                if (screenId === 'timeEntryScreen') {
                    updateRiderDropdown();
                }
                
                // Update leaderboard when viewing
                if (screenId === 'leaderboardScreen') {
                    updateLeaderboard();
                }
            } else {
                updateDebug('ERROR: Screen not found: ' + screenId);
            }
        }

        // Add rider function with duplicate handling
        window.addRider = function() {
            updateDebug('Adding rider...');
            
            const nameInput = document.getElementById('riderName');
            const name = nameInput ? nameInput.value.trim() : '';
            
            if (!name) {
                alert('Voer een naam in!');
                return;
            }
            
            // Check for existing photos for this name
            const existingPhotos = getPhotosForName(name);
            
            if (existingPhotos.length > 0) {
                // Show duplicate modal
                window.duplicateName = name;
                showDuplicateModal(existingPhotos);
                return;
            }
            
            // No duplicates, proceed normally
            createNewRider(name, window.currentPhoto);
        }

        // Create new rider
        function createNewRider(name, photo) {
            const rider = {
                id: generateId(),
                name: name,
                photo: photo,
                time: null,
                timeValue: null,
                timestamp: new Date().toISOString()
            };
            
            window.riders.push(rider);
            
            // Clear inputs
            document.getElementById('riderName').value = '';
            window.currentPhoto = null;
            document.getElementById('photoPreview').innerHTML = '📷';
            document.getElementById('photoInput').value = '';
            
            // Save and update
            saveData();
            updateRidersList();
            updateRiderDropdown();
            
            // Show next button if we have riders
            const nextBtn = document.getElementById('nextToTimeBtn');
            if (nextBtn && window.riders.length > 0) {
                nextBtn.style.display = 'inline-block';
            }
            
            updateDebug('Rider added: ' + name + ' (total: ' + window.riders.length + ')');
        }

        // Show duplicate modal
        function showDuplicateModal(existingPhotos) {
            const modal = document.getElementById('duplicateModal');
            const gallery = document.getElementById('photoGallery');
            const message = document.getElementById('duplicateMessage');
            
            message.textContent = `De naam "${window.duplicateName}" is al gebruikt. Kies een bestaande foto of voeg toe zonder foto:`;
            
            gallery.innerHTML = '';
            
            existingPhotos.forEach((photoData, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-option';
                photoDiv.onclick = () => selectPhoto(photoData.photo, photoDiv);
                
                photoDiv.innerHTML = `
                    <img src="${photoData.photo}" alt="Bestaande foto">
                    <div class="photo-option-text">${photoData.hasTime ? 'Voltooid' : 'Wachtend'}</div>
                `;
                
                gallery.appendChild(photoDiv);
            });
            
            modal.classList.add('active');
        }

        // Select photo in gallery
        function selectPhoto(photo, element) {
            // Remove previous selection
            document.querySelectorAll('.photo-option').forEach(el => el.classList.remove('selected'));
            
            // Select current
            element.classList.add('selected');
            window.selectedPhotoForDuplicate = photo;
        }

        // Use selected photo
        window.useSelectedPhoto = function() {
            if (!window.selectedPhotoForDuplicate) {
                alert('Selecteer eerst een foto!');
                return;
            }
            
            createNewRider(window.duplicateName, window.selectedPhotoForDuplicate);
            closeDuplicateModal();
        }

        // Take new photo for duplicate
        window.takeNewPhoto = function() {
            closeDuplicateModal();
            // The user can now take a new photo and add the rider normally
        }

        // Add without photo for duplicate
        window.addWithoutPhoto = function() {
            createNewRider(window.duplicateName, null);
            closeDuplicateModal();
        }

        // Close duplicate modal
        window.closeDuplicateModal = function() {
            document.getElementById('duplicateModal').classList.remove('active');
            window.duplicateName = '';
            window.selectedPhotoForDuplicate = null;
        }

        // Edit rider function
        window.editRider = function(index) {
            const rider = window.riders[index];
            if (!rider || rider.time) {
                alert('Kan alleen rijders bewerken die nog niet gereden hebben!');
                return;
            }

            window.editingRiderIndex = index;
            
            // Fill modal
            document.getElementById('editRiderName').value = rider.name;
            const editPreview = document.getElementById('editPhotoPreview');
            
            if (rider.photo) {
                editPreview.innerHTML = `<img src="${rider.photo}" alt="Current photo">`;
            } else {
                editPreview.innerHTML = '📷';
            }
            
            // Clear new photo data
            editPreview.dataset.newPhoto = '';
            document.getElementById('editPhotoInput').value = '';
            
            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        // Save edited rider
        window.saveEditedRider = function() {
            if (window.editingRiderIndex === null) return;
            
            const newName = document.getElementById('editRiderName').value.trim();
            if (!newName) {
                alert('Voer een naam in!');
                return;
            }
            
            // Update rider
            const rider = window.riders[window.editingRiderIndex];
            rider.name = newName;
            
            const editPreview = document.getElementById('editPhotoPreview');
            if (editPreview.dataset.newPhoto) {
                rider.photo = editPreview.dataset.newPhoto;
            }
            
            // Save and update
            saveData();
            updateRidersList();
            updateRiderDropdown();
            closeEditModal();
            
            updateDebug('Rider edited: ' + newName);
        }

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editModal').classList.remove('active');
            window.editingRiderIndex = null;
        }

        // Remove rider function  
        window.removeRider = function(index) {
            updateDebug('Removing rider at index: ' + index);
            
            if (window.riders[index]) {
                const rider = window.riders[index];
                
                // Remove from leaderboard if has time
                if (rider.time) {
                    window.leaderboardData = window.leaderboardData.filter(entry => entry.id !== rider.id);
                }
                
                // Remove from riders
                window.riders.splice(index, 1);
                
                // Update UI
                saveData();
                updateRidersList();
                updateRiderDropdown();
                updateLeaderboard();
                
                updateDebug('Rider removed. Remaining: ' + window.riders.length);
            }
        }

        // Update riders list
        function updateRidersList() {
            const container = document.getElementById('addedNames');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Only show riders without time
            const ridersWithoutTime = window.riders.filter(r => !r.time);
            
            ridersWithoutTime.forEach((rider) => {
                const fullIndex = window.riders.findIndex(r => r.id === rider.id);
                
                const tag = document.createElement('div');
                tag.className = 'rider-tag';
                
                tag.innerHTML = `
                    <div class="rider-photo-small">
                        ${rider.photo ? `<img src="${rider.photo}" alt="${rider.name}">` : '👤'}
                    </div>
                    <div class="rider-info">
                        <strong>${rider.name}</strong>
                    </div>
                    <div class="rider-actions">
                        <button class="action-btn" onclick="editRider(${fullIndex})">✏️</button>
                        <button class="action-btn remove-btn" onclick="removeRider(${fullIndex})">×</button>
                    </div>
                `;
                container.appendChild(tag);
            });
            
            if (ridersWithoutTime.length === 0 && window.riders.length > 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Alle rijders hebben al een tijd!</p>';
            }
        }

        // Update dropdown (without IDs)
        function updateRiderDropdown() {
            const select = document.getElementById('riderSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecteer rijder...</option>';
            
            // Only riders without time
            window.riders.forEach((rider, index) => {
                if (!rider.time) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = rider.name; // No ID shown
                    select.appendChild(option);
                }
            });
        }

        // Validate time input fields
        function validateTimeInput(inputId, maxValue, fieldName) {
            const input = document.getElementById(inputId);
            if (!input) return false;
            
            const value = input.value;
            
            // Check if empty (allow empty for optional fields)
            if (value === '' || value === null) {
                return true; // Empty is okay, will default to 0
            }
            
            // Check if it's a valid number
            const numValue = parseFloat(value);
            
            // Must be a natural number (positive integer, no decimals)
            if (!Number.isInteger(numValue) || numValue < 0) {
                alert(`${fieldName} moet een natuurlijk getal zijn (0, 1, 2, 3, ...)!`);
                input.focus();
                return false;
            }
            
            // Check maximum value
            if (numValue > maxValue) {
                alert(`${fieldName} mag maximaal ${maxValue} zijn!`);
                input.focus();
                return false;
            }
            
            return true;
        }

        // Add time function with enhanced validation
        window.addTime = function() {
            updateDebug('Adding time...');
            
            const riderIndex = document.getElementById('riderSelect').value;
            
            if (!riderIndex && riderIndex !== '0') {
                alert('Selecteer een rijder!');
                return;
            }
            
            // Validate all time inputs
            if (!validateTimeInput('minutes', 999, 'Minuten')) return;
            if (!validateTimeInput('seconds', 59, 'Seconden')) return;
            if (!validateTimeInput('hundredths', 99, 'Honderdsten')) return;
            
            // Get values (default to 0 if empty)
            const minutes = document.getElementById('minutes').value || '0';
            const seconds = document.getElementById('seconds').value || '0';
            const hundredths = document.getElementById('hundredths').value || '0';
            
            // Additional validation: ensure they're integers
            const minInt = parseInt(minutes);
            const secInt = parseInt(seconds);
            const hunInt = parseInt(hundredths);
            
            if (minInt.toString() !== minutes || secInt.toString() !== seconds || hunInt.toString() !== hundredths) {
                alert('Alle tijdvelden moeten natuurlijke getallen zijn (geen decimalen)!');
                return;
            }

            const timeString = `${minInt.toString().padStart(2, '0')}:${secInt.toString().padStart(2, '0')}:${hunInt.toString().padStart(2, '0')}`;
            const timeValue = minInt * 6000 + secInt * 100 + hunInt;

            // Update rider
            window.riders[riderIndex].time = timeString;
            window.riders[riderIndex].timeValue = timeValue;

            // Add to leaderboard
            const entry = {
                id: window.riders[riderIndex].id,
                name: window.riders[riderIndex].name,
                photo: window.riders[riderIndex].photo,
                time: timeString,
                timeValue: timeValue,
                timestamp: new Date().toISOString()
            };

            // Remove existing entry if any
            window.leaderboardData = window.leaderboardData.filter(e => e.id !== entry.id);
            window.leaderboardData.push(entry);
            
            // Sort by time (LONGEST first - who stayed on longest)
            window.leaderboardData.sort((a, b) => b.timeValue - a.timeValue);

            // Save and update
            saveData();
            updateRidersList();
            updateRiderDropdown();
            
            // Clear form
            document.getElementById('riderSelect').value = '';
            document.getElementById('minutes').value = '';
            document.getElementById('seconds').value = '';
            document.getElementById('hundredths').value = '';
            
            alert(`✅ Tijd toegevoegd voor ${entry.name}: ${timeString}`);
            updateDebug('Time added for: ' + entry.name);
        }

        // Update leaderboard display as single scrollable list
        function updateLeaderboard() {
            updateLeaderboardList();
        }

        // Update leaderboard list (all positions)
        function updateLeaderboardList() {
            const container = document.getElementById('leaderboardList');
            const section = document.getElementById('leaderboardSection');
            if (!container || !section) return;
            
            if (window.leaderboardData.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nog geen tijden toegevoegd...</p>';
                return;
            }
            
            const leaderboardContainer = document.createElement('div');
            leaderboardContainer.className = 'remaining-leaderboard';
            
            window.leaderboardData.forEach((entry, index) => {
                const position = index + 1; // Start from position 1
                
                const entryDiv = document.createElement('div');
                entryDiv.className = 'remaining-entry';
                
                // Add special styling for top 3
                let medalEmoji = '';
                if (position === 1) medalEmoji = '🥇 ';
                else if (position === 2) medalEmoji = '🥈 ';
                else if (position === 3) medalEmoji = '🥉 ';
                
                entryDiv.innerHTML = `
                    <div class="remaining-position">${medalEmoji}#${position}</div>
                    <div class="remaining-photo">
                        ${entry.photo ? `<img src="${entry.photo}" alt="${entry.name}">` : '👤'}
                    </div>
                    <div class="remaining-name">${entry.name}</div>
                    <div class="remaining-time">${entry.time}</div>
                `;
                
                leaderboardContainer.appendChild(entryDiv);
            });
            
            container.innerHTML = '';
            container.appendChild(leaderboardContainer);
        }

        // Real-time input validation as user types
        function addRealTimeValidation() {
            // Minutes field - allow any natural number
            document.getElementById('minutes').addEventListener('input', function(e) {
                let value = e.target.value;
                // Remove any non-digit characters
                value = value.replace(/[^0-9]/g, '');
                e.target.value = value;
            });
            
            // Seconds field - max 59
            document.getElementById('seconds').addEventListener('input', function(e) {
                let value = e.target.value;
                // Remove any non-digit characters
                value = value.replace(/[^0-9]/g, '');
                // Limit to 59
                if (parseInt(value) > 59) {
                    value = '59';
                }
                e.target.value = value;
            });
            
            // Hundredths field - max 99
            document.getElementById('hundredths').addEventListener('input', function(e) {
                let value = e.target.value;
                // Remove any non-digit characters
                value = value.replace(/[^0-9]/g, '');
                // Limit to 99
                if (parseInt(value) > 99) {
                    value = '99';
                }
                e.target.value = value;
            });
        }

        // Add Enter key support for better UX
        function addEnterKeySupport() {
            // Enter key on rider name adds rider
            document.getElementById('riderName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addRider();
                }
            });
            
            // Enter key on time fields adds time
            ['minutes', 'seconds', 'hundredths'].forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTime();
                    }
                });
            });
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('rodeoRiders', JSON.stringify(window.riders));
                localStorage.setItem('rodeoLeaderboard', JSON.stringify(window.leaderboardData));
                updateDebug('Data saved');
            } catch (e) {
                updateDebug('Save failed: ' + e.message);
            }
        }

        // Load data from localStorage
        function loadData() {
            try {
                const savedRiders = localStorage.getItem('rodeoRiders');
                const savedLeaderboard = localStorage.getItem('rodeoLeaderboard');
                
                if (savedRiders) {
                    window.riders = JSON.parse(savedRiders);
                    updateDebug('Loaded ' + window.riders.length + ' riders');
                }
                
                if (savedLeaderboard) {
                    window.leaderboardData = JSON.parse(savedLeaderboard);
                    updateDebug('Loaded ' + window.leaderboardData.length + ' leaderboard entries');
                }
            } catch (e) {
                updateDebug('Load failed: ' + e.message);
                window.riders = [];
                window.leaderboardData = [];
            }
        }

        // Reset all data
        window.resetAll = function() {
            if (confirm('Weet je zeker dat je alle data wilt wissen?')) {
                window.riders = [];
                window.leaderboardData = [];
                localStorage.removeItem('rodeoRiders');
                localStorage.removeItem('rodeoLeaderboard');
                
                updateRidersList();
                updateRiderDropdown();
                updateLeaderboard();
                
                const nextBtn = document.getElementById('nextToTimeBtn');
                if (nextBtn) nextBtn.style.display = 'none';
                
                showScreen('homeScreen');
                updateDebug('All data reset');
            }
        }

        // Initialize app with all enhancements
        function initApp() {
            updateDebug('Initializing app...');
            
            loadData();
            updateRidersList();
            updateRiderDropdown();
            updateLeaderboard();
            
            // Add the new validation features
            addRealTimeValidation();
            addEnterKeySupport();
            
            // Show next button if we have riders without time
            const ridersWithoutTime = window.riders.filter(r => !r.time);
            const nextBtn = document.getElementById('nextToTimeBtn');
            if (nextBtn && ridersWithoutTime.length > 0) {
                nextBtn.style.display = 'inline-block';
            }
            
            updateDebug('App ready! Functions loaded.');
        }

        // Start app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        updateDebug('Script loaded');
    </script>
</body>
</html>
